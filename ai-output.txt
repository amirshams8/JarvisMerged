// ===== FILE: modules/callhandler/src/main/java/com/jarvismini/callhandler/CallConstants.kt =====
package com.jarvismini.callhandler

object CallConstants {
    const val TAG = "CALL-HANDLER"
    const val AUTO_REPLY_TEXT = "Iâ€™m currently unavailable. Will call you back soon."
}
// ===== FILE: modules/callhandler/src/main/java/com/jarvismini/callhandler/resolver/ContactResolver.kt =====
package com.jarvismini.callhandler.resolver

import android.content.Context
import android.provider.ContactsContract

object ContactResolver {

    fun isContact(context: Context, phone: String): Boolean {
        val uri = ContactsContract.PhoneLookup.CONTENT_FILTER_URI
        val cursor = context.contentResolver.query(
            uri.buildUpon().appendPath(phone).build(),
            arrayOf(ContactsContract.PhoneLookup._ID),
            null,
            null,
            null
        )

        cursor?.use {
            return it.moveToFirst()
        }
        return false
    }
}
// ===== FILE: modules/callhandler/src/main/java/com/jarvismini/callhandler/sms/CallAutoReply.kt =====
package com.jarvismini.callhandler.sms

import android.telephony.SmsManager
import android.util.Log
import com.jarvismini.callhandler.CallConstants

object CallAutoReply {

    fun send(phone: String) {
        try {
            SmsManager.getDefault().sendTextMessage(
                phone,
                null,
                CallConstants.AUTO_REPLY_TEXT,
                null,
                null
            )
            Log.d(CallConstants.TAG, "Auto-reply SMS sent to $phone")
        } catch (e: Exception) {
            Log.e(CallConstants.TAG, "Failed to send SMS", e)
        }
    }
}
// ===== FILE: modules/callhandler/src/main/java/com/jarvismini/callhandler/receiver/CallReceiver.kt =====
package com.jarvismini.callhandler.receiver

import android.content.BroadcastReceiver
import android.content.Context
import android.content.Intent
import android.telephony.TelephonyManager
import android.util.Log
import com.jarvismini.callhandler.CallConstants
import com.jarvismini.callhandler.resolver.ContactResolver
import com.jarvismini.callhandler.sms.CallAutoReply

class CallReceiver : BroadcastReceiver() {

    override fun onReceive(context: Context, intent: Intent) {
        if (intent.action != TelephonyManager.ACTION_PHONE_STATE_CHANGED) return

        val state = intent.getStringExtra(TelephonyManager.EXTRA_STATE)
        if (state != TelephonyManager.EXTRA_STATE_RINGING) return

        val number =
            intent.getStringExtra(TelephonyManager.EXTRA_INCOMING_NUMBER)
                ?: return

        Log.d(CallConstants.TAG, "Incoming call from $number")

        if (!ContactResolver.isContact(context, number)) {
            Log.d(CallConstants.TAG, "Ignored (not a contact)")
            return
        }

        CallAutoReply.send(number)
    }
}
